export type Locale = "pt-BR" | "en-US";

export type TranslateParams = Record<string, string | number>;
export type Translate = (
  key: string,
  params?: TranslateParams,
  fallback?: string,
) => string;

export const DEFAULT_LOCALE: Locale = "pt-BR";
export const SUPPORTED_LOCALES: Locale[] = ["pt-BR", "en-US"];

const MESSAGES = {
  "pt-BR": {
    notFound: {
      tag: "Erro 404",
      title: "Rota nao encontrada",
      description: "A pagina que voce tentou acessar nao esta disponivel.",
      cta: "Ir para o cronograma",
    },
    login: {
      loading: "Carregando login...",
      errorDefault:
        "Nao foi possivel entrar com email e senha. Verifique os dados e tente novamente.",
      brand: "Leads & Tickets",
      heading: "Acesse o painel seguro",
      subheading:
        "Entre para visualizar dashboards e metricas privadas sem flicker.",
      sessionHint:
        "Sessoes sao preservadas com cookies seguros. Faca login para acessar o dashboard.",
      title: "Faca login",
      subtitle: "Entre com email e senha.",
      emailLabel: "Email",
      emailPlaceholder: "seu@email.com",
      passwordLabel: "Senha",
      passwordPlaceholder: "********",
      signingIn: "Entrando...",
      signIn: "Entrar",
    },
    schedule: {
      title: "Cronograma semanal",
      subtitle: "Agendamentos reais carregados do Supabase por semana.",
      tabSchedule: "Cronograma",
      tabCompanies: "Empresas",
      appointmentsCount: "{count} agendamentos",
      companiesCount: "{count} empresas",
      zoomOut: "Diminuir zoom da semana",
      zoomIn: "Aumentar zoom da semana",
      zoomLabel: "Zoom",
      prevMonth: "Mes anterior",
      nextMonth: "Proximo mes",
      timeLabel: "Hora",
      viewBoard: "Quadro",
      viewMap: "Mapa",
      closeCreate: "Fechar criacao",
      createAppointment: "Criar apontamento",
      selectWeek: "Selecionar semana",
      weekOf: "Semana de {label}",
      today: "Hoje",
      actual: "Real",
      scheduleLabel: "Cronograma",
      companiesLabel: "Empresas",
      consultant: "Consultor",
      search: "Busca",
      searchPlaceholderWithConsultant:
        "Buscar por empresa, documento ou carteira",
      searchPlaceholderNoConsultant: "Selecione um consultor",
      orderBy: "Ordenar",
      orderByName: "Nome",
      orderByPreventivas: "Preventivas",
      orderByReconexoes: "Reconexoes",
      orderByQuotes: "Cotacoes abertas",
      emptyConsultant: "Nenhum consultor",
      selectConsultantToViewCompanies:
        "Selecione um consultor para ver as empresas.",
      noCompaniesFound: "Nenhuma empresa encontrada com esses filtros.",
      companyDocumentMissing: "Documento nao informado",
      noState: "Sem estado",
      noCsa: "Sem CSA",
      noCarteira: "Sem carteira",
      noCarteira2: "Sem carteira 2",
      noClass: "Sem classe",
      noClientClass: "Sem classe cliente",
      noReference: "Sem referencia",
      noValidation: "Sem validacao",
      noData: "Sem dados",
      loading: "Carregando...",
      loadingSchedule: "Carregando cronograma...",
      loadingCompanies: "Carregando empresas...",
      protheusLoadError: "Nao foi possivel carregar oportunidades.",
      quotesLoadError: "Nao foi possivel carregar os valores de cotacao.",
      status: {
        scheduled: "Agendado",
        in_progress: "Em execucao",
        done: "Concluido",
        absent: "Ausente",
      },
      map: {
        companies: "Empresas",
        checkIns: "Check-ins",
        checkOuts: "Check-outs",
      },
      timeline: {
        title: "Linha do tempo",
        scheduled: "Agendado",
        checkIn: "Check-in",
        checkOut: "Check-out",
        pending: "Pendente",
        absent: "Ausente",
      },
      opportunity: {
        preventiva: "Preventiva",
        garantia_basica: "Garantia basica",
        garantia_estendida: "Garantia estendida",
        reforma_componentes: "Reforma de componentes",
        lamina: "Lamina",
        dentes: "Dentes",
        rodante: "Rodante",
        disponibilidade: "Disponibilidade",
        reconexao: "Reconexao",
        transferencia_aor: "Transferencia AOR",
        pops: "POPs",
        outros: "Outros",
      },
    },
    map: {
      empty: "Sem coordenadas para exibir no mapa.",
      loading: "Carregando mapa...",
      companyFallback: "Empresa",
      schedulePrefix: "Agendamento",
      checkInPrefix: "Check-in",
      checkOutPrefix: "Check-out",
    },
    createAppointment: {
      dialogLabel: "Criar apontamento",
      title: "Criar apontamento",
      subtitle:
        "Preencha os dados basicos para criar um apontamento no cronograma.",
      close: "Fechar",
      companySection: "Empresa",
      scheduleSection: "Agenda",
      selectConsultantToListCompanies:
        "Selecione um consultor para listar as empresas.",
      selectedCompany: "Empresa selecionada",
      selectCompany: "Selecione a empresa",
      selectConsultantFirst: "Selecione o consultor primeiro",
      companyDocument: "Documento",
      companyState: "Estado",
      companyCsa: "CSA",
      companyEmail: "Email CSA",
      companyPortfolio: "Carteira",
      notInformed: "Nao informado",
      consultant: "Consultor",
      selectConsultant: "Selecione o consultor",
      date: "Data",
      startTime: "Horario inicio",
      endTime: "Horario fim",
      duration: "Duracao estimada",
      timeRequired: "Informe data e horario.",
      timeInvalid: "Horario invalido.",
      timeEndAfterStart: "Horario final deve ser maior que o inicial.",
      availableCompanies: "{count} empresa(s) disponiveis",
      selectConsultantToList: "Selecione um consultor para listar empresas.",
      cancel: "Cancelar",
      creating: "Criando...",
      create: "Criar apontamento",
      createError: "Nao foi possivel criar o apontamento.",
      createSuccess: "Apontamento criado com sucesso.",
    },
    appointment: {
      title: "Apontamento",
      detailsTitle: "Detalhe do apontamento",
      loadingDetails: "Carregando detalhes...",
      loading: "Carregando apontamento...",
      notFound: "Apontamento nao encontrado.",
      notFoundShort: "Nao encontrado",
      errorLoading: "Erro ao carregar",
      loadError: "Nao foi possivel carregar o apontamento.",
      mediaLoadError: "Nao foi possivel carregar as imagens.",
      backToSchedule: "Voltar ao cronograma",
      companyMissing: "Empresa nao informada",
      address: "Endereco",
      consultant: "Consultor",
      notInformed: "Nao informado",
      notes: "Notas",
      opportunities: "Oportunidades percebidas",
      absenceRegistered: "Ausencia registrada",
      reason: "Motivo",
      notesShort: "Obs",
      mediaTitle: "Imagens do apontamento",
      mediaExpire: "URLs expiram em 60s",
      mediaRefresh: "Atualizar imagens",
      mediaLoading: "Carregando imagens...",
      mediaEmpty: "Nenhuma imagem registrada neste apontamento.",
      mediaCount: "{count} imagem(ns)",
      attachment: "Arquivo",
      openAttachment: "Abrir anexo",
      attachmentUnavailable: "Anexo indisponivel",
      timestampUnknown: "Data nao informada",
      mediaKind: {
        checkin: "Check-in",
        checkout: "Check-out",
        absence: "Ausencia",
        other: "Outros",
      },
    },
    company: {
      title: "Empresa",
      loading: "Carregando empresa...",
      loadingData: "Carregando dados...",
      notFound: "Empresa nao encontrada.",
      backToSchedule: "Voltar ao cronograma",
      createAppointment: "Criar apontamento",
      documentMissing: "Documento nao informado",
      appointmentsLoadError: "Nao foi possivel carregar os apontamentos.",
      quotesLoadError: "Nao foi possivel carregar os orcamentos.",
      opportunitiesLoadError: "Nao foi possivel carregar oportunidades.",
      quoteFallback: "Sem",
      noDate: "Sem data",
      noFutureSchedule: "Sem agenda futura",
      appointmentsCount: "{count} apontamentos",
      info: {
        name: "Empresa",
        document: "Documento",
        state: "Estado",
        csa: "CSA",
        emailCsa: "Email CSA",
        carteira: "Carteira",
        carteira2: "Carteira 2",
        class: "Classe",
        clientClass: "Classe cliente",
        validation: "Validacao",
        reference: "Referencia",
        coordinates: "Coordenadas",
      },
      noState: "Sem estado",
      noCsa: "Sem CSA",
      noEmailCsa: "Sem email CSA",
      noCarteira: "Sem carteira",
      noCarteira2: "Sem carteira 2",
      noClass: "Sem classe",
      noClientClass: "Sem classe cliente",
      noValidation: "Sem validacao",
      noReference: "Sem referencia",
      noCoordinates: "Nao informado",
      opportunities: "Oportunidades",
      opportunityTabQuotes: "Cotacao",
      opportunityTabPreventive: "Preventiva",
      opportunityTabReconnect: "Reconexao",
      quotesCount: "{count} orcamentos",
      itemsCount: "{count} itens",
      refresh: "Atualizar",
      loadingQuotes: "Carregando orcamentos...",
      noQuotes: "Nenhum orcamento encontrado para esta empresa.",
      quote: "Orcamento",
      branch: "Filial",
      date: "Data",
      consultant: "Consultor",
      definition: "Definicao",
      class: "Classe",
      client: "Cliente",
      noConsultant: "Nao informado",
      noDefinition: "Sem definicao",
      noClassValue: "Sem classe",
      noClient: "Sem cliente",
      itemsTitle: "Itens do orcamento",
      item: "Item",
      quantity: "Qtd",
      value: "Valor",
      itemNoDescription: "Item sem descricao",
      sourceProtheus: "Fonte: Protheus",
      loadingOpportunities: "Carregando oportunidades...",
      noOpportunities: "Nenhuma oportunidade encontrada para esta empresa.",
      serie: "Serie",
      appointmentsTitle: "Apontamentos",
      recordsCount: "{count} registros",
      loadingAppointments: "Carregando apontamentos...",
      noAppointments: "Nenhum apontamento registrado para esta empresa.",
      appointmentFallback: "Apontamento",
      appointmentSummary: "Resumo dos apontamentos",
      summaryTotal: "{count} total",
      summaryDone: "{count} concluidos",
      summaryInProgress: "{count} em execucao",
      summaryPending: "{count} pendentes",
      summaryAbsent: "{count} ausentes",
      address: "Endereco",
      absence: "Ausencia",
      emptyMap: "Sem coordenadas deste cliente.",
    },
  },
  "en-US": {
    notFound: {
      tag: "Error 404",
      title: "Route not found",
      description: "The page you tried to access is not available.",
      cta: "Go to schedule",
    },
    login: {
      loading: "Loading login...",
      errorDefault:
        "Unable to sign in with email and password. Check your details and try again.",
      brand: "Leads & Tickets",
      heading: "Access the secure panel",
      subheading: "Sign in to view private dashboards and metrics.",
      sessionHint:
        "Sessions are preserved with secure cookies. Sign in to access the dashboard.",
      title: "Sign in",
      subtitle: "Use your email and password.",
      emailLabel: "Email",
      emailPlaceholder: "you@email.com",
      passwordLabel: "Password",
      passwordPlaceholder: "********",
      signingIn: "Signing in...",
      signIn: "Sign in",
    },
    schedule: {
      title: "Weekly schedule",
      subtitle: "Real appointments loaded from Supabase per week.",
      tabSchedule: "Schedule",
      tabCompanies: "Companies",
      appointmentsCount: "{count} appointments",
      companiesCount: "{count} companies",
      zoomOut: "Zoom out",
      zoomIn: "Zoom in",
      zoomLabel: "Zoom",
      prevMonth: "Previous month",
      nextMonth: "Next month",
      timeLabel: "Time",
      viewBoard: "Board",
      viewMap: "Map",
      closeCreate: "Close creation",
      createAppointment: "Create appointment",
      selectWeek: "Select week",
      weekOf: "Week of {label}",
      today: "Today",
      actual: "Actual",
      scheduleLabel: "Schedule",
      companiesLabel: "Companies",
      consultant: "Consultant",
      search: "Search",
      searchPlaceholderWithConsultant: "Search by company, document, or portfolio",
      searchPlaceholderNoConsultant: "Select a consultant",
      orderBy: "Order by",
      orderByName: "Name",
      orderByPreventivas: "Preventive",
      orderByReconexoes: "Reconnect",
      orderByQuotes: "Open quotes",
      emptyConsultant: "No consultant",
      selectConsultantToViewCompanies:
        "Select a consultant to view companies.",
      noCompaniesFound: "No companies found with these filters.",
      companyDocumentMissing: "Document not informed",
      noState: "No state",
      noCsa: "No CSA",
      noCarteira: "No portfolio",
      noCarteira2: "No portfolio 2",
      noClass: "No class",
      noClientClass: "No client class",
      noReference: "No reference",
      noValidation: "No validation",
      noData: "No data",
      loading: "Loading...",
      loadingSchedule: "Loading schedule...",
      loadingCompanies: "Loading companies...",
      protheusLoadError: "Unable to load opportunities.",
      quotesLoadError: "Unable to load quote values.",
      status: {
        scheduled: "Scheduled",
        in_progress: "In progress",
        done: "Done",
        absent: "Absent",
      },
      map: {
        companies: "Companies",
        checkIns: "Check-ins",
        checkOuts: "Check-outs",
      },
      timeline: {
        title: "Timeline",
        scheduled: "Scheduled",
        checkIn: "Check-in",
        checkOut: "Check-out",
        pending: "Pending",
        absent: "Absent",
      },
      opportunity: {
        preventiva: "Preventive",
        garantia_basica: "Basic warranty",
        garantia_estendida: "Extended warranty",
        reforma_componentes: "Component overhaul",
        lamina: "Blade",
        dentes: "Teeth",
        rodante: "Undercarriage",
        disponibilidade: "Availability",
        reconexao: "Reconnect",
        transferencia_aor: "AOR transfer",
        pops: "POPs",
        outros: "Other",
      },
    },
    map: {
      empty: "No coordinates to display on the map.",
      loading: "Loading map...",
      companyFallback: "Company",
      schedulePrefix: "Appointment",
      checkInPrefix: "Check-in",
      checkOutPrefix: "Check-out",
    },
    createAppointment: {
      dialogLabel: "Create appointment",
      title: "Create appointment",
      subtitle: "Fill in the details to create a schedule appointment.",
      close: "Close",
      companySection: "Company",
      scheduleSection: "Schedule",
      selectConsultantToListCompanies:
        "Select a consultant to list companies.",
      selectedCompany: "Selected company",
      selectCompany: "Select the company",
      selectConsultantFirst: "Select the consultant first",
      companyDocument: "Document",
      companyState: "State",
      companyCsa: "CSA",
      companyEmail: "CSA email",
      companyPortfolio: "Portfolio",
      notInformed: "Not informed",
      consultant: "Consultant",
      selectConsultant: "Select the consultant",
      date: "Date",
      startTime: "Start time",
      endTime: "End time",
      duration: "Estimated duration",
      timeRequired: "Provide date and time.",
      timeInvalid: "Invalid time.",
      timeEndAfterStart: "End time must be after start time.",
      availableCompanies: "{count} company(ies) available",
      selectConsultantToList: "Select a consultant to list companies.",
      cancel: "Cancel",
      creating: "Creating...",
      create: "Create appointment",
      createError: "Unable to create the appointment.",
      createSuccess: "Appointment created successfully.",
    },
    appointment: {
      title: "Appointment",
      detailsTitle: "Appointment details",
      loadingDetails: "Loading details...",
      loading: "Loading appointment...",
      notFound: "Appointment not found.",
      notFoundShort: "Not found",
      errorLoading: "Error loading",
      loadError: "Unable to load the appointment.",
      mediaLoadError: "Unable to load the images.",
      backToSchedule: "Back to schedule",
      companyMissing: "Company not informed",
      address: "Address",
      consultant: "Consultant",
      notInformed: "Not informed",
      notes: "Notes",
      opportunities: "Opportunities identified",
      absenceRegistered: "Absence recorded",
      reason: "Reason",
      notesShort: "Note",
      mediaTitle: "Appointment images",
      mediaExpire: "URLs expire in 60s",
      mediaRefresh: "Refresh images",
      mediaLoading: "Loading images...",
      mediaEmpty: "No images recorded for this appointment.",
      mediaCount: "{count} image(s)",
      attachment: "File",
      openAttachment: "Open attachment",
      attachmentUnavailable: "Attachment unavailable",
      timestampUnknown: "Date not informed",
      mediaKind: {
        checkin: "Check-in",
        checkout: "Check-out",
        absence: "Absence",
        other: "Other",
      },
    },
    company: {
      title: "Company",
      loading: "Loading company...",
      loadingData: "Loading data...",
      notFound: "Company not found.",
      backToSchedule: "Back to schedule",
      createAppointment: "Create appointment",
      documentMissing: "Document not informed",
      appointmentsLoadError: "Unable to load appointments.",
      quotesLoadError: "Unable to load quotes.",
      opportunitiesLoadError: "Unable to load opportunities.",
      quoteFallback: "N/A",
      noDate: "No date",
      noFutureSchedule: "No upcoming schedule",
      appointmentsCount: "{count} appointments",
      info: {
        name: "Company",
        document: "Document",
        state: "State",
        csa: "CSA",
        emailCsa: "CSA email",
        carteira: "Portfolio",
        carteira2: "Portfolio 2",
        class: "Class",
        clientClass: "Client class",
        validation: "Validation",
        reference: "Reference",
        coordinates: "Coordinates",
      },
      noState: "No state",
      noCsa: "No CSA",
      noEmailCsa: "No CSA email",
      noCarteira: "No portfolio",
      noCarteira2: "No portfolio 2",
      noClass: "No class",
      noClientClass: "No client class",
      noValidation: "No validation",
      noReference: "No reference",
      noCoordinates: "Not informed",
      opportunities: "Opportunities",
      opportunityTabQuotes: "Quote",
      opportunityTabPreventive: "Preventive",
      opportunityTabReconnect: "Reconnect",
      quotesCount: "{count} quotes",
      itemsCount: "{count} items",
      refresh: "Refresh",
      loadingQuotes: "Loading quotes...",
      noQuotes: "No quotes found for this company.",
      quote: "Quote",
      branch: "Branch",
      date: "Date",
      consultant: "Consultant",
      definition: "Definition",
      class: "Class",
      client: "Client",
      noConsultant: "Not informed",
      noDefinition: "No definition",
      noClassValue: "No class",
      noClient: "No client",
      itemsTitle: "Quote items",
      item: "Item",
      quantity: "Qty",
      value: "Value",
      itemNoDescription: "Item with no description",
      sourceProtheus: "Source: Protheus",
      loadingOpportunities: "Loading opportunities...",
      noOpportunities: "No opportunities found for this company.",
      serie: "Series",
      appointmentsTitle: "Appointments",
      recordsCount: "{count} records",
      loadingAppointments: "Loading appointments...",
      noAppointments: "No appointments registered for this company.",
      appointmentFallback: "Appointment",
      appointmentSummary: "Appointment summary",
      summaryTotal: "{count} total",
      summaryDone: "{count} done",
      summaryInProgress: "{count} in progress",
      summaryPending: "{count} pending",
      summaryAbsent: "{count} absent",
      address: "Address",
      absence: "Absence",
      emptyMap: "No coordinates for this client.",
    },
  },
} as const;

export type Messages = (typeof MESSAGES)[Locale];

const resolveLocale = (value: string | null | undefined): Locale => {
  if (!value) return DEFAULT_LOCALE;
  const normalized = value.trim().replace("_", "-").toLowerCase();
  if (normalized.startsWith("pt")) return "pt-BR";
  if (normalized.startsWith("en")) return "en-US";
  return DEFAULT_LOCALE;
};

type HeaderSource =
  | Headers
  | { get?: (name: string) => string | null }
  | Record<string, string | string[] | undefined>
  | null
  | undefined;

const readHeader = (source: HeaderSource, name: string): string | null => {
  if (!source) return null;
  if (typeof (source as Headers).get === "function") {
    return (source as Headers).get(name);
  }
  const target = name.toLowerCase();
  for (const [key, value] of Object.entries(source)) {
    if (key.toLowerCase() !== target) continue;
    if (Array.isArray(value)) return value.join(",");
    return value ?? null;
  }
  return null;
};

export const getLocaleFromHeaders = (headers: HeaderSource): Locale => {
  const header = readHeader(headers, "accept-language");
  if (!header) return DEFAULT_LOCALE;
  const parts = header.split(",").map((part) => part.trim());
  for (const part of parts) {
    const lang = part.split(";")[0]?.trim();
    if (!lang) continue;
    const locale = resolveLocale(lang);
    if (SUPPORTED_LOCALES.includes(locale)) return locale;
  }
  return DEFAULT_LOCALE;
};

export const getMessages = (locale: Locale): Messages =>
  MESSAGES[locale] ?? MESSAGES[DEFAULT_LOCALE];

const getMessageValue = (messages: Messages, key: string): string | undefined => {
  const parts = key.split(".");
  let current: unknown = messages;
  for (const part of parts) {
    if (!current || typeof current !== "object") return undefined;
    current = (current as Record<string, unknown>)[part];
  }
  return typeof current === "string" ? current : undefined;
};

export const createTranslator = (messages: Messages): Translate => {
  return (key, params, fallback) => {
    const template = getMessageValue(messages, key);
    if (!template) return fallback ?? key;
    if (!params) return template;
    return template.replace(/\{(\w+)\}/g, (_, token) =>
      token in params ? String(params[token]) : "",
    );
  };
};
